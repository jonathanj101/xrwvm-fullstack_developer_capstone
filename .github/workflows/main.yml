name: 'Lint Code'

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint_python:
    name: Lint Python Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run flake8 and show offending lines
        run: |
          echo "🔍 Running flake8..."
          ERRORS=$(flake8 . --exit-zero)
          echo "$ERRORS"

          echo "🔍 Offending lines with visible whitespace/symbols:"
          while read -r LINE; do
            FILE=$(echo "$LINE" | cut -d':' -f1)
            LINENO=$(echo "$LINE" | cut -d':' -f2)
            CODE=$(echo "$LINE" | cut -d':' -f4 | awk '{print $1}')
            CONTEXT=$(sed -n "${LINENO}p" "$FILE" | cat -A)
            echo "[$CODE] $FILE:$LINENO => $CONTEXT"
          done <<< "$ERRORS"

          echo "❌ Linting completed with above issues."
          exit 1

  lint_js:
    name: Lint JavaScript Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 14

      - name: Install JSHint
        run: npm install jshint --global

      - name: Run Linter
        run: |
          echo "🔍 Running JSHint..."
          find ./server/database -name "*.js" -exec jshint {} +
          echo "✅ Linted all the js files successfully"
